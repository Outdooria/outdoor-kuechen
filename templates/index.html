<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Outdoor-Küche Vorschau (Konva.Shape Verzerrung)</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; margin: 0; }
    #konva-container { border: 1px solid #ccc; margin: 20px auto; display: inline-block; max-width: 90%; }
    .gallery { display: flex; gap: 16px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
    .card { width: 200px; padding: 12px; border-radius: 10px; border: 1px solid #ddd; text-align: center; }
    .card img { width: 100%; height: auto; }
    .card button { margin-top: 6px; }
    #controls { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    button, select { padding: 10px 14px; border: none; border-radius: 6px; background: #0077cc; color: #fff; cursor: pointer; }
    #kitchenSelect { background: #555; min-width: 180px; }
    #groupBtn { background:#6f42c1; }
    #ungroupBtn { background:#20c997; }
    #deleteKitchenBtn { background:#dc3545; }
    #preview img { max-width: 100%; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Outdoor-Küche Vorschau (Konva.Shape Verzerrung)</h2>

  <form id="uploadForm" enctype="multipart/form-data">
    <p>Terrassenfoto hochladen:</p>
    <input type="file" id="terrasseInput" accept="image/*,.heic,.heif" required><br><br>
    <p>Eigene Küche hochladen (optional):</p>
    <input type="file" id="kuecheInput" accept="image/*"><br><br>
    <button type="submit">Fotos verarbeiten</button>
  </form>

  <div class="gallery" id="gallery"></div>

  <div id="controls">
    <select id="kitchenSelect" multiple size="3"></select>
    <button type="button" id="toggleGridBtn">Raster anzeigen</button>
    <button type="button" id="groupBtn">Gruppieren</button>
    <button type="button" id="ungroupBtn">Gruppe lösen</button>
    <button type="button" id="deleteKitchenBtn">Küche löschen</button>
    <button type="button" id="downloadBtn">Bild speichern</button>
  </div>

  <div id="konva-container"></div>
  <div id="preview"></div>

  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <script>
    let stage, layer, terrasseImg;
    let kitchens = [];
    let groups = [];
    let transformer;

    function initStage(width, height) {
      document.getElementById("konva-container").innerHTML = "";
      stage = new Konva.Stage({ container: 'konva-container', width, height });
      layer = new Konva.Layer();
      stage.add(layer);

      transformer = new Konva.Transformer({
        rotateEnabled: true,
        enabledAnchors: ["top-left", "top-right", "bottom-left", "bottom-right"],
        ignoreStroke: true
      });
      layer.add(transformer);

      kitchens = [];
      groups = [];
      updateDropdown();
    }

    // Terrasse hochladen
    document.getElementById("terrasseInput").addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const maxWidth = Math.min(window.innerWidth * 0.9, 1000);
          const scale = img.width > maxWidth ? maxWidth / img.width : 1;
          initStage(img.width * scale, img.height * scale);
          terrasseImg = new Konva.Image({
            image: img, x: 0, y: 0, width: img.width * scale, height: img.height * scale
          });
          layer.add(terrasseImg); layer.draw();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Galerie laden
    fetch(window.location.origin + "/static/kitchens.json")
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const card=document.createElement("div");
          card.className="card";
          card.innerHTML=`
            <img src="${item.image}" alt="${item.name}">
            <h4>${item.name}</h4>
            <p>${item.description}</p>
            <button>Hinzufügen</button>
          `;
          card.querySelector("button").addEventListener("click", ()=> addKitchen(item.image));
          document.getElementById("gallery").appendChild(card);
        });
      });

    // Küche hinzufügen mit Shape
    function addKitchen(src) {
      const img = new Image();
      img.onload = () => {
        const w = 250, h = (img.height/img.width)*250;
        const startX = 100, startY = 100;

        // 4 Eckpunkte
        const handles = [
          new Konva.Circle({ x: startX,   y: startY,   radius: 6, fill: "red", draggable: true }),
          new Konva.Circle({ x: startX+w, y: startY,   radius: 6, fill: "red", draggable: true }),
          new Konva.Circle({ x: startX+w, y: startY+h, radius: 6, fill: "red", draggable: true }),
          new Konva.Circle({ x: startX,   y: startY+h, radius: 6, fill: "red", draggable: true })
        ];

        // Shape
        const kitchenShape = new Konva.Shape({
          sceneFunc: function(ctx, shape) {
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(handles[0].x(), handles[0].y());
            ctx.lineTo(handles[1].x(), handles[1].y());
            ctx.lineTo(handles[2].x(), handles[2].y());
            ctx.lineTo(handles[3].x(), handles[3].y());
            ctx.closePath();
            ctx.clip();

            // Bild einfach in Startrechteck zeichnen
            ctx.drawImage(img, startX, startY, w, h);
            ctx.restore();
          }
        });

        layer.add(kitchenShape);
        handles.forEach(h => layer.add(h));

        // Handles -> redraw
        handles.forEach(h => h.on("dragmove", () => {
          kitchenShape.getLayer().batchDraw();
        }));

        layer.draw();

        const id = "Küche " + (kitchens.length+1);
        kitchens.push({ id, shape: kitchenShape, handles, group: null });
        updateDropdown();
      };
      img.src = src;
    }

    // Dropdown aktualisieren
    function updateDropdown() {
      const select = document.getElementById("kitchenSelect");
      select.innerHTML = "";
      kitchens.forEach((k,i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = k.id + (k.group ? " (Gruppe)" : "");
        select.appendChild(opt);
      });
    }

    // Gruppieren
    document.getElementById("groupBtn").addEventListener("click", () => {
      const select = document.getElementById("kitchenSelect");
      const selected = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
      if (selected.length < 2) return;

      const group = new Konva.Group({ draggable: true });
      selected.forEach(i => {
        const k = kitchens[i];
        if (!k.group) {
          group.add(k.shape);
          k.handles.forEach(h => h.hide());
          k.group = group;
        }
      });
      layer.add(group);
      groups.push(group);

      transformer.nodes([group]);
      layer.draw();
      updateDropdown();
    });

    // Gruppe lösen
    document.getElementById("ungroupBtn").addEventListener("click", () => {
      groups.forEach(g => {
        g.getChildren().forEach(child => {
          layer.add(child);
          const k = kitchens.find(k => k.shape === child);
          if (k) {
            k.group = null;
            k.handles.forEach(h => h.show());
          }
        });
        g.destroy();
      });
      transformer.nodes([]);
      groups = [];
      layer.draw();
      updateDropdown();
    });

    // Küche löschen
    document.getElementById("deleteKitchenBtn").addEventListener("click", () => {
      const select = document.getElementById("kitchenSelect");
      const selected = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
      selected.sort((a,b)=>b-a);
      selected.forEach(i => {
        const k = kitchens[i];
        k.shape.destroy();
        k.handles.forEach(h => h.destroy());
        kitchens.splice(i,1);
      });
      transformer.nodes([]);
      layer.draw();
      updateDropdown();
    });

    // Raster
    let gridOn = false;
    document.getElementById("toggleGridBtn").addEventListener("click", (e) => {
      gridOn = !gridOn;
      layer.find(".gridLine").forEach(l => l.destroy());
      if (gridOn) {
        const gridSize = 50;
        for (let i = 0; i < stage.width() / gridSize; i++) {
          layer.add(new Konva.Line({ points:[i*gridSize,0,i*gridSize,stage.height()], stroke:"#ddd", strokeWidth:1, name:"gridLine" }));
        }
        for (let j = 0; j < stage.height() / gridSize; j++) {
          layer.add(new Konva.Line({ points:[0,j*gridSize,stage.width(),j*gridSize], stroke:"#ddd", strokeWidth:1, name:"gridLine" }));
        }
        e.target.textContent = "Raster ausblenden";
      } else {
        e.target.textContent = "Raster anzeigen";
      }
      layer.draw();
    });

    // Download
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const dataURL = stage.toDataURL({ pixelRatio: 2 });
      const link = document.createElement("a");
      link.download = "outdoor_kueche.png";
      link.href = dataURL;
      link.click();
      document.getElementById("preview").innerHTML = `<h3>Vorschau:</h3><img src="${dataURL}">`;
    });
  </script>
</body>
</html>
