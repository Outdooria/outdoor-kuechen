<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Outdoor-Küche Vorschau</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; margin: 0; }
    #container {
      position: relative; display: inline-block; border: 1px solid #ccc;
      margin-top: 20px; background-size: 20px 20px;
      max-width: 100%;
    }
    #container.grid {
      background-image:
        linear-gradient(to right, #ddd 1px, transparent 1px),
        linear-gradient(to bottom, #ddd 1px, transparent 1px);
    }
    #terrasse { max-width: 100%; display: block; }
    .kueche-wrapper {
      position: absolute; display: inline-block;
      transform-origin: center center; border: 2px dashed transparent;
    }
    .kueche-wrapper.active { border: 2px dashed #0077cc; }
    .kueche { width: 300px; display: block; cursor: move; touch-action: none; }
    .handle {
      position: absolute; width: 20px; height: 20px;
      background: #0077cc; border-radius: 50%; display: none;
    }
    .kueche-wrapper.active .handle { display: block; }
    .resizeHandle { right: -10px; bottom: -10px; cursor: se-resize; }
    .rotateHandle { left: 50%; top: -30px; margin-left: -10px; cursor: grab; }
    .gallery {
      display: flex; gap: 16px; justify-content: center;
      margin: 20px 0; flex-wrap: wrap;
    }
    .card { width: 200px; padding: 12px; border-radius: 10px; border: 1px solid #ddd; text-align: center; }
    .card img { width: 100%; height: auto; }
    .card button { margin-top: 6px; }
    #kitchenList {
      margin-top: 20px; text-align: left; max-width: 800px;
      margin-left: auto; margin-right: auto; border: 1px solid #ccc;
      border-radius: 6px; padding: 10px;
    }
    #kitchenList h3 { margin-top: 0; text-align: center; }
    .list-item {
      display: flex; justify-content: space-between;
      align-items: center; padding: 6px; border-bottom: 1px solid #eee;
    }
    .list-item.active { background: #eef6ff; }
    .list-item input { border: 1px solid #ccc; border-radius: 4px; padding: 4px; flex: 1; }
    .list-item button { background: #dc3545; margin-left: 10px; }
    button {
      padding: 10px 14px; border: none; border-radius: 6px;
      background: #0077cc; color: #fff; cursor: pointer;
    }
    button.small { padding: 6px 10px; font-size: 14px; }
    #controls { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    #projects { margin: 20px auto; max-width: 800px; text-align: left; }
    #projects h3 { text-align: center; }
    #projects ul { list-style: none; padding: 0; }
    #projects li { padding: 6px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }

    /* �� Mobile Anpassungen */
    @media (max-width: 768px) {
      .gallery { flex-direction: column; align-items: center; }
      .card { width: 90%; margin-bottom: 16px; }
      button { width: 100%; margin-top: 6px; }
      #controls { flex-direction: column; }
      #kitchenList { font-size: 14px; }
    }
  </style>
</head>
<body>
  <h2>Outdoor-Küche Vorschau</h2>

  <form id="uploadForm" enctype="multipart/form-data">
    <p>Terrassenfoto hochladen:</p>
    <input type="file" name="terrasse" accept="image/*" required><br><br>
    <p>Eigene Küche hochladen (optional):</p>
    <input type="file" name="kueche" accept="image/*"><br><br>
    <button type="submit" class="small">Fotos verarbeiten (nur für eigene Küche)</button>
  </form>

  <!-- Galerie -->
  <div class="gallery" id="gallery"></div>

  <!-- Zusatz-Steuerung -->
  <div id="controls">
    <button type="button" id="toggleGridBtn">Raster anzeigen</button>
    <button type="button" id="undoBtn">⮪ Undo</button>
    <button type="button" id="redoBtn">Redo ⮫</button>
    <button type="button" id="resetBtn" style="background:#dc3545">Reset</button>
  </div>

  <!-- Container -->
  <div id="container">
    <img id="terrasse" alt="Terrasse">
  </div>

  <!-- Liste -->
  <div id="kitchenList">
    <h3>Platzierten Küchen</h3>
    <div id="listItems"></div>
  </div>

  <!-- Projektverwaltung -->
  <div id="projects">
    <h3>Projekte</h3>
    <input type="text" id="projectName" placeholder="Projektname eingeben">
    <button type="button" id="saveProjectBtn">Projekt speichern</button>
    <button type="button" id="exportProjectsBtn">Projekte exportieren</button>
    <input type="file" id="importProjectsInput" accept="application/json" style="display:none">
    <button type="button" id="importProjectsBtn">Projekte importieren</button>

    <label>
      <input type="radio" name="importMode" value="merge" checked> Ergänzen
    </label>
    <label>
      <input type="radio" name="importMode" value="replace"> Ersetzen
    </label>

    <ul id="projectList"></ul>
    <button type="button" id="clearProjectsBtn" style="background:#dc3545;margin-top:10px">
      Alle Projekte löschen
    </button>
  </div>

  <br>
  <button id="downloadBtn" style="display:none">Bild speichern</button>

  <canvas id="resultCanvas" style="display:none;"></canvas>

  <script>
    const container = document.getElementById("container");
    const terrasse = document.getElementById("terrasse");
    const gallery = document.getElementById("gallery");
    const downloadBtn = document.getElementById("downloadBtn");
    const listItems = document.getElementById("listItems");

    let activeKitchen = null;
    let kitchenCounter = 0;
    const GRID_SIZE = 20;

    function getClientPos(e) {
      if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      } else {
        return { x: e.clientX, y: e.clientY };
      }
    }

    function addKitchen(src, name = "Küche") {
      kitchenCounter++;
      const wrapper = document.createElement("div");
      wrapper.className = "kueche-wrapper";
      wrapper.style.left = "100px"; wrapper.style.top = "100px";
      wrapper.dataset.rotation = 0; wrapper.dataset.name = name + " " + kitchenCounter;

      const img = document.createElement("img"); img.src = src; img.className = "kueche";
      const resize = document.createElement("div"); resize.className = "handle resizeHandle";
      const rotate = document.createElement("div"); rotate.className = "handle rotateHandle";

      wrapper.appendChild(img); wrapper.appendChild(resize); wrapper.appendChild(rotate);
      container.appendChild(wrapper);
      setActiveKitchen(wrapper);
      makeInteractive(wrapper, img, resize, rotate);
      updateList();
      downloadBtn.style.display = "inline-block";
    }

    function setActiveKitchen(wrapper) {
      document.querySelectorAll(".kueche-wrapper").forEach(w => w.classList.remove("active"));
      wrapper.classList.add("active");
      activeKitchen = wrapper;
      updateList();
    }

    function updateList() {
      listItems.innerHTML = "";
      document.querySelectorAll(".kueche-wrapper").forEach(wrapper => {
        const div = document.createElement("div");
        div.className = "list-item";
        if (wrapper.classList.contains("active")) div.classList.add("active");
        div.textContent = wrapper.dataset.name;
        listItems.appendChild(div);
      });
    }

    function makeInteractive(wrapper, img, resize, rotate) {
      wrapper.addEventListener("mousedown", () => setActiveKitchen(wrapper));
      wrapper.addEventListener("touchstart", () => setActiveKitchen(wrapper));

      let dragging=false, offsetX=0, offsetY=0;

      img.addEventListener("mousedown", e => { dragging=true; offsetX=e.offsetX; offsetY=e.offsetY; });
      img.addEventListener("touchstart", e => { 
        const pos=getClientPos(e); 
        dragging=true; 
        offsetX=pos.x-wrapper.getBoundingClientRect().left; 
        offsetY=pos.y-wrapper.getBoundingClientRect().top; 
        e.preventDefault(); 
      });

      document.addEventListener("mousemove", e => {
        if (dragging) {
          const rect=container.getBoundingClientRect();
          let newLeft=e.clientX-rect.left-offsetX;
          let newTop=e.clientY-rect.top-offsetY;
          wrapper.style.left=newLeft+"px"; wrapper.style.top=newTop+"px";
        }
      });
      document.addEventListener("touchmove", e => {
        if (dragging) {
          const pos=getClientPos(e);
          const rect=container.getBoundingClientRect();
          let newLeft=pos.x-rect.left-offsetX;
          let newTop=pos.y-rect.top-offsetY;
          wrapper.style.left=newLeft+"px"; wrapper.style.top=newTop+"px";
        }
      });
      document.addEventListener("mouseup", ()=>{ dragging=false; });
      document.addEventListener("touchend", ()=>{ dragging=false; });
    }

    fetch(window.location.origin + "/static/kitchens.json")
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const card=document.createElement("div");
          card.className="card";
          card.innerHTML=`
            <img src="${item.image}" alt="${item.name}">
            <h4>${item.name}</h4>
            <p>${item.description}</p>
            <button>Hinzufügen</button>
          `;
          card.querySelector("button").addEventListener("click", ()=> addKitchen(item.image,item.name));
          gallery.appendChild(card);
        });
      });
  </script>
</body>
</html>
