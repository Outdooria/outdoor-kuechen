<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Outdoor-Küche Vorschau (Konva)</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; margin: 0; }
    #konva-container { border: 1px solid #ccc; margin: 20px auto; display: inline-block; }
    .gallery { display: flex; gap: 16px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
    .card { width: 200px; padding: 12px; border-radius: 10px; border: 1px solid #ddd; text-align: center; }
    .card img { width: 100%; height: auto; }
    .card button { margin-top: 6px; }
    #controls { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    button { padding: 10px 14px; border: none; border-radius: 6px; background: #0077cc; color: #fff; cursor: pointer; }
    #preview img { max-width: 100%; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; }
    @media (max-width: 768px) {
      .gallery { flex-direction: column; align-items: center; }
      .card { width: 90%; margin-bottom: 16px; }
      button { width: 100%; margin-top: 6px; }
      #controls { flex-direction: column; }
    }
  </style>
</head>
<body>
  <h2>Outdoor-Küche Vorschau (Konva)</h2>

  <form id="uploadForm" enctype="multipart/form-data">
    <p>Terrassenfoto hochladen:</p>
    <input type="file" id="terrasseInput" accept="image/*,.heic,.heif" required><br><br>
    <p>Eigene Küche hochladen (optional):</p>
    <input type="file" id="kuecheInput" accept="image/*"><br><br>
    <button type="submit">Fotos verarbeiten</button>
  </form>

  <!-- Galerie -->
  <div class="gallery" id="gallery"></div>

  <!-- Steuerung -->
  <div id="controls">
    <button type="button" id="toggleGridBtn">Raster anzeigen</button>
    <button type="button" id="undoBtn">⮪ Undo</button>
    <button type="button" id="redoBtn">Redo ⮫</button>
    <button type="button" id="resetBtn" style="background:#dc3545">Reset</button>
    <button type="button" id="downloadBtn">Bild speichern</button>
  </div>

  <!-- Konva Stage -->
  <div id="konva-container"></div>

  <!-- Vorschau -->
  <div id="preview"></div>

  <!-- Konva.js -->
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <script>
    let stage, layer, terrasseImg;
    let undoStack = [], redoStack = [];

    // --- Stage initialisieren ---
    function initStage(width = 800, height = 600) {
      document.getElementById("konva-container").innerHTML = "";
      stage = new Konva.Stage({
        container: 'konva-container',
        width: width,
        height: height
      });
      layer = new Konva.Layer();
      stage.add(layer);
    }

    // --- Terrasse laden ---
    document.getElementById("terrasseInput").addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          initStage(img.width, img.height);
          terrasseImg = new Konva.Image({ image: img, x: 0, y: 0, width: img.width, height: img.height });
          layer.add(terrasseImg);
          layer.draw();
          saveState();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // --- Eigene Küche hochladen ---
    document.getElementById("uploadForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const file = document.getElementById("kuecheInput").files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => { addKitchen(ev.target.result, "Eigene Küche"); };
      reader.readAsDataURL(file);
    });

    // --- Galerie laden ---
    fetch(window.location.origin + "/static/kitchens.json")
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const card=document.createElement("div");
          card.className="card";
          card.innerHTML=`
            <img src="${item.image}" alt="${item.name}">
            <h4>${item.name}</h4>
            <p>${item.description}</p>
            <button>Hinzufügen</button>
          `;
          card.querySelector("button").addEventListener("click", ()=> addKitchen(item.image,item.name));
          document.getElementById("gallery").appendChild(card);
        });
      });

    // --- Küche hinzufügen ---
    function addKitchen(src, name="Küche") {
      Konva.Image.fromURL(src, function(img) {
        img.setAttrs({
          x: 100,
          y: 100,
          width: 300,
          height: 200,
          draggable: true,
          name: name
        });

        // Transformations-Tool
        const tr = new Konva.Transformer({
          nodes: [img],
          enabledAnchors: ['top-left','top-right','bottom-left','bottom-right'], // 4 Eckpunkte
          boundBoxFunc: (oldBox, newBox) => newBox
        });

        img.on("click", () => {
          tr.nodes([img]);
        });

        layer.add(img);
        layer.add(tr);
        layer.draw();
        saveState();
      });
    }

    // --- Undo/Redo ---
    function saveState() {
      const json = stage.toJSON();
      undoStack.push(json);
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];
    }

    document.getElementById("undoBtn").addEventListener("click", () => {
      if (undoStack.length > 1) {
        redoStack.push(undoStack.pop());
        const state = undoStack[undoStack.length - 1];
        stage.destroy();
        stage = Konva.Node.create(state, 'konva-container');
      }
    });

    document.getElementById("redoBtn").addEventListener("click", () => {
      if (redoStack.length > 0) {
        const state = redoStack.pop();
        undoStack.push(state);
        stage.destroy();
        stage = Konva.Node.create(state, 'konva-container');
      }
    });

    // --- Reset ---
    document.getElementById("resetBtn").addEventListener("click", () => {
      if (!terrasseImg) return;
      initStage(terrasseImg.width(), terrasseImg.height());
      layer.add(terrasseImg);
      layer.draw();
      saveState();
    });

    // --- Raster ---
    let gridOn = false;
    document.getElementById("toggleGridBtn").addEventListener("click", (e) => {
      gridOn = !gridOn;
      layer.find(".gridLine").forEach(l => l.destroy());
      if (gridOn) {
        const gridSize = 50;
        for (let i = 0; i < stage.width() / gridSize; i++) {
          layer.add(new Konva.Line({
            points: [i*gridSize, 0, i*gridSize, stage.height()],
            stroke: "#ddd", strokeWidth: 1, name: "gridLine"
          }));
        }
        for (let j = 0; j < stage.height() / gridSize; j++) {
          layer.add(new Konva.Line({
            points: [0, j*gridSize, stage.width(), j*gridSize],
            stroke: "#ddd", strokeWidth: 1, name: "gridLine"
          }));
        }
        e.target.textContent = "Raster ausblenden";
      } else {
        e.target.textContent = "Raster anzeigen";
      }
      layer.draw();
    });

    // --- Download ---
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const dataURL = stage.toDataURL({ pixelRatio: 2 });
      const link = document.createElement("a");
      link.download = "outdoor_kueche.png";
      link.href = dataURL;
      link.click();

      document.getElementById("preview").innerHTML = `
        <h3>Vorschau:</h3>
        <img src="${dataURL}">
      `;
    });
  </script>
</body>
</html>
