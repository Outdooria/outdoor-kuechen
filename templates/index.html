<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Outdoor-Küche Vorschau</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; margin: 0; }
    #container {
      position: relative; display: inline-block; border: 1px solid #ccc;
      margin-top: 20px; background-size: 20px 20px;
      max-width: 100%;
    }
    #container.grid {
      background-image:
        linear-gradient(to right, #ddd 1px, transparent 1px),
        linear-gradient(to bottom, #ddd 1px, transparent 1px);
    }
    #terrasse { max-width: 100%; display: block; }
    .kueche-wrapper {
      position: absolute; display: inline-block;
      transform-origin: center center; border: 2px dashed transparent;
    }
    .kueche-wrapper.active { border: 2px dashed #0077cc; }
    .kueche { width: 300px; display: block; cursor: move; touch-action: none; }
    .handle {
      position: absolute; width: 20px; height: 20px;
      background: #0077cc; border-radius: 50%; display: none;
    }
    .kueche-wrapper.active .handle { display: block; }
    .resizeHandle { right: -10px; bottom: -10px; cursor: se-resize; }
    .rotateHandle { left: 50%; top: -30px; margin-left: -10px; cursor: grab; }
    .gallery {
      display: flex; gap: 16px; justify-content: center;
      margin: 20px 0; flex-wrap: wrap;
    }
    .card { width: 200px; padding: 12px; border-radius: 10px; border: 1px solid #ddd; text-align: center; }
    .card img { width: 100%; height: auto; }
    .card button { margin-top: 6px; }
    #kitchenList {
      margin-top: 20px; text-align: left; max-width: 800px;
      margin-left: auto; margin-right: auto; border: 1px solid #ccc;
      border-radius: 6px; padding: 10px;
    }
    #kitchenList h3 { margin-top: 0; text-align: center; }
    .list-item {
      display: flex; justify-content: space-between;
      align-items: center; padding: 6px; border-bottom: 1px solid #eee;
    }
    .list-item.active { background: #eef6ff; }
    .list-item button {
      background: #dc3545; color: #fff; border: none; border-radius: 4px;
      cursor: pointer; padding: 4px 8px;
    }
    button {
      padding: 10px 14px; border: none; border-radius: 6px;
      background: #0077cc; color: #fff; cursor: pointer;
    }
    button.small { padding: 6px 10px; font-size: 14px; }
    #controls { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    #preview { margin-top: 20px; }
    #preview img {
      max-width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    #preview button { margin: 5px; }

    /* �� Mobile Anpassungen */
    @media (max-width: 768px) {
      .gallery { flex-direction: column; align-items: center; }
      .card { width: 90%; margin-bottom: 16px; }
      button { width: 100%; margin-top: 6px; }
      #controls { flex-direction: column; }
      #kitchenList { font-size: 14px; }
    }
  </style>
</head>
<body>
  <h2>Outdoor-Küche Vorschau</h2>

  <form id="uploadForm" enctype="multipart/form-data">
    <p>Terrassenfoto hochladen:</p>
    <input type="file" name="terrasse" accept="image/*,.heic,.heif" required><br><br>
    <p>Eigene Küche hochladen (optional):</p>
    <input type="file" name="kueche" accept="image/*"><br><br>
    <button type="submit" class="small">Fotos verarbeiten (nur für eigene Küche)</button>
  </form>

  <!-- Galerie -->
  <div class="gallery" id="gallery"></div>

  <!-- Zusatz-Steuerung -->
  <div id="controls">
    <button type="button" id="toggleGridBtn">Raster anzeigen</button>
    <button type="button" id="undoBtn">⮪ Undo</button>
    <button type="button" id="redoBtn">Redo ⮫</button>
    <button type="button" id="resetBtn" style="background:#dc3545">Reset</button>
  </div>

  <!-- Container -->
  <div id="container">
    <img id="terrasse" alt="Terrasse">
  </div>

  <!-- Liste -->
  <div id="kitchenList">
    <h3>Platzierten Küchen</h3>
    <div id="listItems"></div>
  </div>

  <br>
  <button id="downloadBtn" style="display:none">Bild speichern</button>

  <!-- Vorschau -->
  <div id="preview"></div>

  <canvas id="resultCanvas" style="display:none;"></canvas>

  <script>
    const container = document.getElementById("container");
    const terrasse = document.getElementById("terrasse");
    const gallery = document.getElementById("gallery");
    const downloadBtn = document.getElementById("downloadBtn");
    const listItems = document.getElementById("listItems");
    const uploadForm = document.getElementById("uploadForm");
    const terrasseInput = document.querySelector('input[name="terrasse"]');
    const kuecheInput   = document.querySelector('input[name="kueche"]');
    const previewDiv = document.getElementById("preview");

    let activeKitchen = null;
    let kitchenCounter = 0;
    let undoStack = [];
    let redoStack = [];

    // --- State Management ---
    function saveState() {
      const state = Array.from(document.querySelectorAll(".kueche-wrapper")).map(w => ({
        src: w.querySelector("img").src,
        name: w.dataset.name,
        left: w.style.left,
        top: w.style.top,
        width: w.querySelector("img").style.width,
        rotation: w.dataset.rotation
      }));
      undoStack.push(JSON.stringify(state));
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];
    }

    function restoreState(stateStr) {
      document.querySelectorAll(".kueche-wrapper").forEach(w => w.remove());
      const state = JSON.parse(stateStr);
      state.forEach(item => {
        addKitchen(item.src, item.name, item.left, item.top, item.width, item.rotation, false);
      });
    }

    // --- Terrasse laden ---
    terrasseInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => { terrasse.src = ev.target.result; };
      reader.readAsDataURL(file);
    });

    // --- Eigene Küche hochladen ---
    uploadForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const file = kuecheInput.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => { addKitchen(ev.target.result, "Eigene Küche"); };
      reader.readAsDataURL(file);
    });

    // --- Galerie laden ---
    fetch(window.location.origin + "/static/kitchens.json")
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const card=document.createElement("div");
          card.className="card";
          card.innerHTML=`
            <img src="${item.image}" alt="${item.name}">
            <h4>${item.name}</h4>
            <p>${item.description}</p>
            <button>Hinzufügen</button>
          `;
          card.querySelector("button").addEventListener("click", ()=> addKitchen(item.image,item.name));
          gallery.appendChild(card);
        });
      })
      .catch(err => console.error("Galerie-Fehler:", err));

    // --- Küche hinzufügen ---
    function addKitchen(src, name="Küche", left="100px", top="100px", width="300px", rotation=0, pushState=true) {
      kitchenCounter++;
      const wrapper=document.createElement("div");
      wrapper.className="kueche-wrapper";
      wrapper.style.left=left; wrapper.style.top=top;
      wrapper.dataset.rotation=rotation; wrapper.dataset.name=name;

      const img=document.createElement("img"); img.src=src; img.className="kueche"; img.style.width=width;
      const resize=document.createElement("div"); resize.className="handle resizeHandle";
      const rotate=document.createElement("div"); rotate.className="handle rotateHandle";

      wrapper.appendChild(img); wrapper.appendChild(resize); wrapper.appendChild(rotate);
      container.appendChild(wrapper);
      setActiveKitchen(wrapper);
      makeInteractive(wrapper,img,resize,rotate);
      updateList();
      downloadBtn.style.display="inline-block";
      if (pushState) saveState();
    }

    // --- Aktive Küche setzen ---
    function setActiveKitchen(wrapper) {
      document.querySelectorAll(".kueche-wrapper").forEach(w=>w.classList.remove("active"));
      wrapper.classList.add("active");
      activeKitchen=wrapper;
      updateList();
    }

    // --- Liste aktualisieren ---
    function updateList() {
      listItems.innerHTML="";
      document.querySelectorAll(".kueche-wrapper").forEach(wrapper=>{
        const div=document.createElement("div");
        div.className="list-item";
        if(wrapper.classList.contains("active")) div.classList.add("active");
        div.textContent=wrapper.dataset.name;

        const btn=document.createElement("button");
        btn.textContent="✖";
        btn.addEventListener("click", ()=>{
          wrapper.remove();
          updateList();
          saveState();
        });
        div.appendChild(btn);
        listItems.appendChild(div);
      });
    }

    // --- Hilfsfunktion ---
    function getClientPos(e) {
      if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      } else {
        return { x: e.clientX, y: e.clientY };
      }
    }

    // --- Küche interaktiv machen ---
    function makeInteractive(wrapper,img,resize,rotate) {
      wrapper.addEventListener("mousedown",()=>setActiveKitchen(wrapper));
      wrapper.addEventListener("touchstart",()=>setActiveKitchen(wrapper));

      let dragging=false, resizing=false, rotating=false;
      let offsetX=0, offsetY=0, startX=0, startY=0, startWidth=0, startHeight=0, startAngle=0;

      img.addEventListener("mousedown", e=>{ dragging=true; offsetX=e.offsetX; offsetY=e.offsetY; });
      img.addEventListener("touchstart", e=>{
        const pos=getClientPos(e);
        dragging=true;
        offsetX=pos.x-wrapper.getBoundingClientRect().left;
        offsetY=pos.y-wrapper.getBoundingClientRect().top;
        e.preventDefault();
      });

      resize.addEventListener("mousedown", e=>{
        e.stopPropagation();
        resizing=true;
        startX=e.clientX; startY=e.clientY;
        startWidth=img.offsetWidth; startHeight=img.offsetHeight;
      });
      resize.addEventListener("touchstart", e=>{
        e.stopPropagation();
        const pos=getClientPos(e);
        resizing=true;
        startX=pos.x; startY=pos.y;
        startWidth=img.offsetWidth; startHeight=img.offsetHeight;
        e.preventDefault();
      });

      rotate.addEventListener("mousedown", e=>{
        e.stopPropagation();
        rotating=true;
        startX=e.clientX; startY=e.clientY;
        const rect=wrapper.getBoundingClientRect();
        startAngle=Math.atan2(startY-rect.top-rect.height/2,startX-rect.left-rect.width/2)-parseFloat(wrapper.dataset.rotation||"0");
      });
      rotate.addEventListener("touchstart", e=>{
        e.stopPropagation();
        const pos=getClientPos(e);
        rotating=true;
        startX=pos.x; startY=pos.y;
        const rect=wrapper.getBoundingClientRect();
        startAngle=Math.atan2(startY-rect.top-rect.height/2,pos.x-rect.left-rect.width/2)-parseFloat(wrapper.dataset.rotation||"0");
        e.preventDefault();
      });

      document.addEventListener("mousemove", e=>{
        if(dragging){
          const rect=container.getBoundingClientRect();
          wrapper.style.left=(e.clientX-rect.left-offsetX)+"px";
          wrapper.style.top=(e.clientY-rect.top-offsetY)+"px";
        }
        if(resizing){
          let dx=e.clientX-startX;
          img.style.width=(startWidth+dx)+"px";
          img.style.height="auto";
        }
        if(rotating){
          const rect=wrapper.getBoundingClientRect();
          const angle=Math.atan2(e.clientY-rect.top-rect.height/2,e.clientX-rect.left-rect.width/2)-startAngle;
          wrapper.dataset.rotation=angle;
          wrapper.style.transform=`rotate(${angle}rad)`;
        }
      });

      document.addEventListener("touchmove", e=>{
        const pos=getClientPos(e);
        if(dragging){
          const rect=container.getBoundingClientRect();
          wrapper.style.left=(pos.x-rect.left-offsetX)+"px";
          wrapper.style.top=(pos.y-rect.top-offsetY)+"px";
        }
        if(resizing){
          let dx=pos.x-startX;
          img.style.width=(startWidth+dx)+"px";
          img.style.height="auto";
        }
        if(rotating){
          const rect=wrapper.getBoundingClientRect();
          const angle=Math.atan2(pos.y-rect.top-rect.height/2,pos.x-rect.left-rect.width/2)-startAngle;
          wrapper.dataset.rotation=angle;
          wrapper.style.transform=`rotate(${angle}rad)`;
        }
      });

      document.addEventListener("mouseup", ()=>{ if(dragging||resizing||rotating) saveState(); dragging=resizing=rotating=false; });
      document.addEventListener("touchend", ()=>{ if(dragging||resizing||rotating) saveState(); dragging=resizing=rotating=false; });
    }

    // --- Buttons ---
    document.getElementById("toggleGridBtn").addEventListener("click", (e) => {
      container.classList.toggle("grid");
      if (container.classList.contains("grid")) {
        e.target.textContent = "Raster ausblenden";
      } else {
        e.target.textContent = "Raster anzeigen";
      }
    });

    document.getElementById("undoBtn").addEventListener("click", () => {
      if (undoStack.length > 1) {
        redoStack.push(undoStack.pop());
        restoreState(undoStack[undoStack.length - 1]);
      }
    });

    document.getElementById("redoBtn").addEventListener("click", () => {
      if (redoStack.length > 0) {
        const state = redoStack.pop();
        undoStack.push(state);
        restoreState(state);
      }
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.querySelectorAll(".kueche-wrapper").forEach(w => w.remove());
      updateList();
      undoStack = [];
      redoStack = [];
    });

    // --- Download + Vorschau + Teilen ---
    downloadBtn.addEventListener("click", () => {
      const canvas = document.getElementById("resultCanvas");
      const ctx = canvas.getContext("2d");

      canvas.width = terrasse.naturalWidth;
      canvas.height = terrasse.naturalHeight;

      ctx.drawImage(terrasse, 0, 0, canvas.width, canvas.height);

      document.querySelectorAll(".kueche-wrapper").forEach(wrapper => {
        const img = wrapper.querySelector("img");
        if (!img.complete) return;

        const scale = img.offsetWidth / img.naturalWidth;
        const rotation = parseFloat(wrapper.dataset.rotation || "0");

        const rectTerrasse = terrasse.getBoundingClientRect();
        const rectWrapper = wrapper.getBoundingClientRect();
        const scaleX = canvas.width / rectTerrasse.width;
        const scaleY = canvas.height / rectTerrasse.height;

        const x = (rectWrapper.left - rectTerrasse.left) * scaleX;
        const y = (rectWrapper.top - rectTerrasse.top) * scaleY;

        const w = img.naturalWidth * scale * scaleX;
        const h = img.naturalHeight * scale * scaleY;

        ctx.save();
        ctx.translate(x + w/2, y + h/2);
        ctx.rotate(rotation);
        ctx.drawImage(img, -w/2, -h/2, w, h);
        ctx.restore();
      });

      const dataURL = canvas.toDataURL("image/png");

      // Download
      const link = document.createElement("a");
      link.download = "outdoor_kueche.png";
      link.href = dataURL;
      link.click();

      // Vorschau + Teilen
      previewDiv.innerHTML = `
        <h3>Vorschau:</h3>
        <img src="${dataURL}" alt="Vorschau">
        <br>
        <button onclick="downloadPreview('${dataURL}')">Download aus Vorschau</button>
        <button onclick="shareWhatsApp()">�� WhatsApp teilen</button>
        <button onclick="shareEmail()">�� E-Mail teilen</button>
      `;
    });

    function downloadPreview(url) {
      const link = document.createElement("a");
      link.download = "outdoor_kueche.png";
      link.href = url;
      link.click();
    }

    function shareWhatsApp() {
      const text = "Schau dir meine geplante Outdoor-Küche an! " + window.location.href;
      window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(text), "_blank");
    }

    function shareEmail() {
      const subject = "Meine Outdoor-Küche";
      const body = "Hallo,\n\nschau dir meine geplante Outdoor-Küche an!\n\n" + window.location.href;
      window.location.href = "mailto:?subject=" + encodeURIComponent(subject) + "&body=" + encodeURIComponent(body);
    }
  </script>
</body>
</html>
