<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Outdoor Küchen Konfigurator</title>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .toolbar {
      display: flex; flex-wrap: wrap; gap: 10px;
      padding: 10px; background: #f0f0f0; border-bottom: 1px solid #ccc;
    }
    #container { width: 100%; height: 80vh; border: 1px solid #ccc; }
    select, input, button { padding: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="toolbar">
    <label>Terrasse hochladen: <input type="file" id="terraceUpload"></label>
    <label>Eigene Küche hochladen: <input type="file" id="kitchenUpload"></label>
    <select id="kitchenSelect" multiple size="3" style="min-width:150px;"></select>
    <button type="button" id="deleteKitchenBtn">Küche löschen</button>
    <button type="button" id="toggleGridBtn">Raster anzeigen</button>
    <button type="button" id="groupBtn">Gruppieren</button>
    <button type="button" id="ungroupBtn">Gruppe lösen</button>
    <button type="button" id="scaleModeBtn">Skaliermodus</button>
  </div>
  <div id="container"></div>

  <script>
    let stage, layer, transformer;
    let gridLayer;
    let gridVisible = false;
    let kitchens = [];
    let currentGroup = null;
    let scaleMode = false;

    // Stage initialisieren
    function initStage(width, height) {
      if (stage) stage.destroy();
      stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
      });

      // Raster-Layer
      gridLayer = new Konva.Layer();
      stage.add(gridLayer);

      // Küchen-Layer
      layer = new Konva.Layer();
      stage.add(layer);

      // Transformer
      transformer = new Konva.Transformer({
        rotateEnabled: true,
        enabledAnchors: ["top-left", "top-right", "bottom-left", "bottom-right"]
      });
      layer.add(transformer);
    }

    // Raster zeichnen
    function drawGrid() {
      gridLayer.destroyChildren();
      if (!gridVisible) return;

      const spacing = 50;
      const w = stage.width();
      const h = stage.height();

      for (let x = 0; x < w; x += spacing) {
        gridLayer.add(new Konva.Line({
          points: [x, 0, x, h],
          stroke: '#ccc',
          strokeWidth: 1
        }));
      }
      for (let y = 0; y < h; y += spacing) {
        gridLayer.add(new Konva.Line({
          points: [0, y, w, y],
          stroke: '#ccc',
          strokeWidth: 1
        }));
      }
      gridLayer.draw();
    }

    // Dropdown aktualisieren
    function updateDropdown() {
      const sel = document.getElementById("kitchenSelect");
      sel.innerHTML = "";
      kitchens.forEach((k, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = "Küche " + (i + 1);
        sel.appendChild(opt);
      });
    }

    // Terrasse hochladen
    document.getElementById("terraceUpload").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const img = new Image();
        img.onload = () => {
          initStage(img.width, img.height);
          const terrace = new Konva.Image({ image: img, x: 0, y: 0, width: img.width, height: img.height });
          stage.add(new Konva.Layer().add(terrace));
          stage.draw();
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Galerie laden
    fetch("/static/kitchens.json")
      .then(r => r.json())
      .then(data => {
        const sel = document.getElementById("kitchenSelect");
        data.kitchens.forEach((src, i) => {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = "Küche " + (i + 1);
          sel.appendChild(opt);
          const img = new Image();
          img.onload = () => {
            kitchens.push({ imageNode: new Konva.Image({ image: img, x: 50 + i*30, y: 50 + i*30, width: 200, height: img.height * 200/img.width }), handles: [] });
            layer.add(kitchens[kitchens.length-1].imageNode);
            layer.draw();
          };
          img.src = src;
        });
      });

    // Eigene Küche hochladen
    document.getElementById("kitchenUpload").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("image", file);

      const res = await fetch("/upload-kitchen", { method: "POST", body: formData });
      const data = await res.json();

      if (data.url) {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          const kitchen = { imageNode: new Konva.Image({ image: img, x: 100, y: 100, width: 200, height: img.height * 200/img.width }), handles: [] };
          kitchens.push(kitchen);
          layer.add(kitchen.imageNode);
          updateDropdown();
          layer.draw();
        };
        img.src = data.url;
      } else {
        alert("Fehler beim Freistellen: " + (data.error || "Unbekannt"));
      }
    });

    // Küche löschen
    document.getElementById("deleteKitchenBtn").addEventListener("click", () => {
      const sel = document.getElementById("kitchenSelect");
      if (!sel.selectedOptions.length) {
        alert("Bitte zuerst eine Küche auswählen.");
        return;
      }
      const idx = parseInt(sel.selectedOptions[0].value);
      const k = kitchens[idx];
      k.imageNode.destroy();
      kitchens.splice(idx, 1);
      transformer.nodes([]);
      layer.draw();
      updateDropdown();
    });

    // Raster anzeigen
    document.getElementById("toggleGridBtn").addEventListener("click", () => {
      gridVisible = !gridVisible;
      drawGrid();
    });

    // Gruppieren
    document.getElementById("groupBtn").addEventListener("click", () => {
      const sel = document.getElementById("kitchenSelect");
      const indices = Array.from(sel.selectedOptions).map(opt => parseInt(opt.value));
      if (indices.length < 2) {
        alert("Bitte mindestens zwei Küchen auswählen.");
        return;
      }
      const group = new Konva.Group({ draggable: true });
      layer.add(group);
      indices.forEach(i => {
        const k = kitchens[i];
        group.add(k.imageNode);
      });
      transformer.nodes([group]);
      currentGroup = group;
      layer.draw();
    });

    // Gruppe lösen
    document.getElementById("ungroupBtn").addEventListener("click", () => {
      if (!currentGroup) {
        alert("Keine Gruppe ausgewählt.");
        return;
      }
      const children = currentGroup.getChildren();
      children.each(node => { layer.add(node); });
      currentGroup.destroy();
      currentGroup = null;
      transformer.nodes([]);
      layer.draw();
    });

    // Skaliermodus
    document.getElementById("scaleModeBtn").addEventListener("click", () => {
      scaleMode = !scaleMode;
      transformer.enabledAnchors(scaleMode ? ["top-left","top-right","bottom-left","bottom-right"] : []);
      layer.draw();
    });

    // Start-Stage
    initStage(800, 600);
  </script>
</body>
</html>
