<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Outdoor-Küche Vorschau</title>
  <style>
    :root { --max-canvas: 95vw; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; text-align: center; }
    #konva-container { border: 1px solid #ccc; margin: 16px auto; display: inline-block; max-width: var(--max-canvas); }
    .gallery { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin: 16px 0; }
    .card { width: 200px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; background: #fff; }
    .card img { width: 100%; height: auto; border-radius: 8px; }
    #controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 12px 0; }
    button, select, input[type=file] {
      padding: 10px 14px; border-radius: 6px; border: none; color: #fff; background: #0077cc; cursor: pointer;
    }
    #toggleGridBtn{ background:#17a2b8;}
    #groupBtn { background:#6f42c1; }
    #ungroupBtn{background:#20c997;}
    #deleteKitchenBtn{background:#dc3545;}
    #scaleModeBtn{background:#ff8800;}
    #downloadBtn{background:#2b9348;}
    #kitchenSelect{ background:#555; min-width: 220px; }
    #preview{ min-height: 24px; }
    #preview p{ margin: 8px 0 0; }
    label { cursor: pointer; color:#222; }
    input[type=file] { background:#28a745; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2>Outdoor-Küche Vorschau</h2>

  <!-- Terrasse -->
  <div>
    <label>Terrassenfoto hochladen:
      <input type="file" id="terrasseInput" accept="image/*,.heic,.heif" />
    </label>
  </div>

  <!-- Eigene Küche -->
  <div style="margin-top:8px;">
    <label>Eigene Küche hochladen:
      <input type="file" id="kitchenUpload" accept="image/*" />
    </label>
  </div>

  <!-- Galerie -->
  <div class="gallery" id="gallery"></div>

  <!-- Controls -->
  <div id="controls">
    <select id="kitchenSelect" multiple size="3" title="Mehrfachauswahl mit STRG/CMD">
    </select>
    <button type="button" id="toggleGridBtn">Raster anzeigen</button>
    <button type="button" id="scaleModeBtn">Skaliermodus umschalten</button>
    <button type="button" id="groupBtn">Gruppieren</button>
    <button type="button" id="ungroupBtn">Gruppe lösen</button>
    <button type="button" id="deleteKitchenBtn">Küche löschen</button>
    <button type="button" id="downloadBtn">Bild speichern</button>
  </div>

  <!-- Canvas + Preview -->
  <div id="konva-container"></div>
  <div id="preview"></div>

  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <script>
    // --- Globale State-Variablen ---
    let stage, bgLayer, gridLayer, layer, transformer, terrasseImg;
    let kitchens = [];
    let currentGroup = null;
    let scaleMode = null;
    let gridVisible = false;

    // --- Stage initialisieren ---
    function initStage(width, height) {
      document.getElementById('konva-container').innerHTML = '';
      stage = new Konva.Stage({ container: 'konva-container', width, height });
      bgLayer = new Konva.Layer(); stage.add(bgLayer);
      gridLayer = new Konva.Layer(); stage.add(gridLayer);
      layer = new Konva.Layer(); stage.add(layer);

      transformer = new Konva.Transformer({
        rotateEnabled: true,
        enabledAnchors: ['top-left','top-right','bottom-left','bottom-right'],
        ignoreStroke: true,
        keepRatio: true
      });
      layer.add(transformer);

      kitchens = [];
      currentGroup = null;
      updateDropdown();
      if (gridVisible) { drawGrid(); } else { gridLayer.destroyChildren(); gridLayer.draw(); }
    }

    // --- Terrasse laden ---
    document.getElementById('terrasseInput').addEventListener('change', (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const maxW = Math.min(window.innerWidth * 0.95, 1200);
          const scale = img.width > maxW ? maxW / img.width : 1;
          initStage(Math.round(img.width * scale), Math.round(img.height * scale));
          terrasseImg = new Konva.Image({
            image: img, x: 0, y: 0, width: img.width*scale, height: img.height*scale
          });
          bgLayer.add(terrasseImg); bgLayer.draw();
          if (gridVisible) { drawGrid(); }
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // --- Galerie laden ---
    fetch(window.location.origin + '/static/kitchens.json')
      .then(r => r.json())
      .then(items => {
        const list = Array.isArray(items) ? items : (Array.isArray(items.kitchens) ? items.kitchens : []);
        const g = document.getElementById('gallery'); g.innerHTML = '';
        list.forEach(item => {
          const imgSrc = typeof item === 'string' ? item : item.image;
          const name = typeof item === 'object' && item.name ? item.name : 'Küche';
          const desc = typeof item === 'object' && item.description ? item.description : '';
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <img src="${imgSrc}" alt="${name}">
            <h4>${name}</h4>
            <p>${desc}</p>
            <button>Hinzufügen</button>
          `;
          card.querySelector('button').addEventListener('click', () => addKitchen(imgSrc));
          g.appendChild(card);
        });
      })
      .catch(err => console.error('Fehler beim Laden der Galerie:', err));

    // --- Warping Math (gleich geblieben) ---
    function mapTriangle(ctx, s0,s1,s2, d0,d1,d2) { /* ... unverändert ... */ }
    function warpToCanvas(baseCanvas, viewCanvas, dstPts) { /* ... unverändert ... */ }

    // --- Küche hinzufügen (jetzt größer: 600px Breite) ---
    function addKitchen(url) {
      const img = new Image();
      if (!url.startsWith("data:")) { img.crossOrigin = "anonymous"; }
      img.onload = () => {
        const targetW = 600, targetH = (img.height/img.width)*600;

        const baseCanvas = document.createElement('canvas');
        baseCanvas.width = targetW; baseCanvas.height = targetH;
        baseCanvas.getContext('2d').drawImage(img,0,0,targetW,targetH);

        const viewCanvas = document.createElement('canvas');
        viewCanvas.width = targetW; viewCanvas.height = targetH;

        const startX=100, startY=100;
        const handles=[
          new Konva.Circle({x:startX,y:startY,radius:7,fill:'red',draggable:true}),
          new Konva.Circle({x:startX+targetW,y:startY,radius:7,fill:'red',draggable:true}),
          new Konva.Circle({x:startX+targetW,y:startY+targetH,radius:7,fill:'red',draggable:true}),
          new Konva.Circle({x:startX,y:startY+targetH,radius:7,fill:'red',draggable:true})
        ];
        handles.forEach(h=>layer.add(h));

        const imageNode = new Konva.Image({
          image:viewCanvas,x:startX,y:startY,width:viewCanvas.width,height:viewCanvas.height,draggable:true
        });
        layer.add(imageNode);

        function updateWarp() { /* ... unverändert ... */ }
        updateWarp();

        handles.forEach(h=>h.on('dragmove',updateWarp));
        let lastPos={x:imageNode.x(),y:imageNode.y()};
        imageNode.on('dragstart',()=>{lastPos={x:imageNode.x(),y:imageNode.y()};});
        imageNode.on('dragmove',()=>{ /* ... unverändert ... */ });

        const id='Küche '+(kitchens.length+1);
        kitchens.push({id,baseCanvas,viewCanvas,imageNode,handles,group:null});
        updateDropdown(); layer.draw();
      };
      img.src=url;
    }

    // --- Restlicher Code bleibt wie in deiner stabilen Version ---
    // updateDropdown, scaleModeBtn, deleteKitchenBtn, grid, group/ungroup, upload, download...

    initStage(800, 500);
  </script>
</body>
</html>
